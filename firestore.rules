/**
 * @fileOverview Firestore Security Rules for BookWise AI.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and private book lists.
 * Public book lists are readable by anyone, but writable only by their owners. Books are readable by anyone, but only created, updated, and deleted by authenticated users with an ownerId field.
 *
 * Data Structure:
 * - /users/{userId}: User profile data.
 * - /users/{userId}/book_lists/{bookListId}: Private book lists owned by a specific user.
 * - /public_book_lists/{bookListId}: Public book lists accessible to all.
 * - /books/{bookId}: Book data.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data.
 * - Users can only read and write their own private book lists.
 * - Public book lists are readable by anyone but only writable by their owners.
 * - Listing of user documents is disallowed.
 *
 * Denormalization for Authorization:
 * The `userId` field within the BookList document (in both private and public collections) is used to enforce ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profile data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get) User with ID 'user123' can read their own profile.
     * @allow (update) User with ID 'user123' can update their own profile.
     * @allow (delete) User with ID 'user123' can delete their own profile.
     * @deny (create) User with ID 'user456' cannot create a profile for 'user123'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      //Function to check if the user is the owner
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false; // Prevent listing all users
      allow create: if isOwner(userId);
      allow update: if isOwner(userId); // Enforce immutability of userId.
      allow delete: if isOwner(userId);
    }

    /**
     * @description Enforces user-ownership for private book lists stored under a user's profile.
     * @path /users/{userId}/book_lists/{bookListId}
     * @allow (create) User with ID 'user123' can create a book list under their profile.
     * @allow (get) User with ID 'user123' can read a book list under their profile.
     * @allow (update) User with ID 'user123' can update a book list under their profile.
     * @allow (delete) User with ID 'user123' can delete a book list under their profile.
     * @deny (create) User with ID 'user456' cannot create a book list under 'user123's profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/book_lists/{bookListId} {
      //Function to check if the user is the owner
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(userId) && getSelf().data.userId == request.auth.uid;
      allow delete: if isOwner(userId) && getSelf().data.userId == request.auth.uid;
            function getSelf() {
        return get(/databases/$(database)/documents/users/$(userId)/book_lists/$(bookListId));
      }
    }

    /**
     * @description Allows public read access to public book lists while restricting write access to the owner.
     * @path /public_book_lists/{bookListId}
     * @allow (get) Anyone can read a public book list.
     * @allow (list) Anyone can list public book lists.
     * @allow (create) User with ID 'user123' can create a public book list with userId 'user123'.
     * @allow (update) User with ID 'user123' can update a public book list they own.
     * @deny (create) User with ID 'user123' cannot create a public book list with userId 'user456'.
     * @deny (update) User with ID 'user456' cannot update a public book list owned by 'user123'.
     * @principle Enforces document ownership for writes while allowing public read access.
     */
    match /public_book_lists/{bookListId} {
      //Function to check if the user is the owner
      function isOwner(ownerId) {
        return request.auth.uid == ownerId;
      }
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && getSelf().data.userId == request.auth.uid;
      allow delete: if request.auth != null && getSelf().data.userId == request.auth.uid;
            function getSelf() {
        return get(/databases/$(database)/documents/public_book_lists/$(bookListId));
      }
    }

    /**
     * @description Allows public read access to book data, with write access restricted to authenticated users.
     * @path /books/{bookId}
     * @allow (get) Anyone can read book data.
     * @allow (list) Anyone can list books.
     * @allow (create) Authenticated user can create book data.
     * @allow (update) Authenticated user can update book data if document exists.
     * @allow (delete) Authenticated user can delete book data if document exists.
     * @principle Allows open reads for books, but requires authentication for writes.
     */
    match /books/{bookId} {
      allow get: if true;
      allow list: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null && true;
      allow delete: if request.auth != null && true;
    }
  }
}